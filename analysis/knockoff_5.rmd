---
title: "Variable Selection in Linear Regression"
author: "Lei Sun"
date: 2018-02-01
output: html_document
---

<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
```{r read-chunk, include=FALSE, cache=FALSE}
knitr::read_chunk("chunks.R")
```

<!-- Update knitr chunk options -->
```{r knitr-opts-chunk, include=FALSE}
```

<!-- Insert the date the file was last updated -->
```{r last-updated, echo=FALSE, results='asis'}
```

<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
```{r code-version, echo=FALSE, results='asis'}
```

<!-- Add your analysis here -->

```{r, echo = FALSE, eval = FALSE}
fdp <- function(selected) sum(beta[selected] == 0) / max(length(selected), 1)
power <- function(selected, k = k) sum(beta[selected] != 0) / max(k, 1)

set.seed(777)

n <- 3000
p <- 1000
k <- 200
q <- 0.1
sigma.beta <- 3.5
sigma.e <- 1

X <- matrix(rnorm(n * p), n , p)
X <- t(t(X) / sqrt(colSums(X^2)))
beta <- rep(0, p)
nonzero <- sample(p, k)
beta[nonzero[1 : (k/2)]] <- sigma.beta * sigma.e
beta[nonzero[(k/2 + 1) : k]] <- -sigma.beta * sigma.e
signal <- rnorm(k, 0, 2.5)
beta[nonzero] <- signal * as.numeric(abs(signal) >= 3.5)
e <- rnorm(n)
y <- X %*% beta + e

## Least squares
ls.time <- system.time(lm.fit <- lm(y ~ X - 1))[3]
betahat <- coef(lm.fit)
sebetahat <- summary(lm.fit)$coefficients[, 2]
pvalue <- summary(lm.fit)$coefficients[, 4]
zscore <- -qnorm(pvalue / 2) * sign(summary(lm.fit)$coefficients[, 3])

## BH
BH.time <- system.time(BH.fit <- p.adjust(pvalue, method = "BH"))[3]
BH.selected <- (1 : p)[BH.fit <= q]

## qvalue
qvalue.time <- system.time(qvalue.fit <- qvalue::qvalue(pvalue))[3]
qvalue.selected <- (1 : p)[qvalue.fit$qvalues <= q]

## Knockoff
knockoff.time <- system.time(knockoff.fit <- knockoff::knockoff.filter(X, y, knockoffs = create.fixed, statistic = stat.glmnet_lambdasmax, fdr = q))[3]
knockoff.selected <- knockoff.fit$selected

fdp(BH.selected)
power(BH.selected, sum(beta != 0))
fdp(qvalue.selected)
power(qvalue.selected, sum(beta != 0))
fdp(knockoff.selected)
power(knockoff.selected, sum(beta != 0))



beta.col <- rep("grey90", p)
beta.col[nonzero] <- "red"
plot(sort(zscore), col = beta.col[order(zscore)], pch = 19, cex = 0.5)

```

## Session information

<!-- Insert the session information into the document -->
```{r session-info}
```
